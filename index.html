<html>
<head>
	<meta charset="utf-8"> <meta http-equiv="content-type" content="text/html; charset=utf-8">
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<title>GlassGameDataAnalysis</title>
	<script>

	d3.csv("./data.csv", function(RawData) 
	{
	   var GlassType = ["Google","Epson"];
	   var GlassTypeOffset = 13;
	   var ConstraintType = ["On-Body","Phone","In-Air"];
	   var ConstraintTypeOffset = 4;

       var dateIndex = 1;
	   var userNameIndex = 2;
	   var methodDescriptionIndex = 4;
	   var intentIndex = 3;
	   var videoIndex = 5;
	   var whyIndex = 6;
	   var firstRatingIndex = 7;
	   var preferSequenceIndex = 16;

	   
	   //Get Gesture Data Array
	   var GestureDataArray = [];
	   for (var i = 0; i < RawData.length; i++) 
	   {
	   		var CurrentData = RawData[i];

   			for(var ConstraintCounter = 0; ConstraintCounter<ConstraintType.length;ConstraintCounter++)
   			{
   				for (var GlassCounter = 0 ; GlassCounter<GlassType.length;GlassCounter++)
   				{
	   				var offset = ConstraintCounter*ConstraintTypeOffset+GlassCounter*GlassTypeOffset;

		   			var GestureData = {};
		   			GestureData.GlassType = GlassType[GlassCounter];
		   			GestureData.ConstraintType = ConstraintType[ConstraintCounter];
			   		GestureData.name = CurrentData[userNameIndex];
			   		GestureData.intent = CurrentData[intentIndex];
			   		GestureData.rating = parseInt(CurrentData[offset+firstRatingIndex]);
			   		GestureData.why = CurrentData[offset+whyIndex];
			   		GestureData.video = CurrentData[offset+videoIndex];
			   		GestureData.method = CurrentData[offset+methodDescriptionIndex];
			   		GestureData.date = CurrentData[dateIndex];
			   		GestureData.rawDataIndex = i;

					var shiftValue;
			   		if(GlassCounter==0)
			   			shiftValue = GlassTypeOffset;
			   		else
			   			shiftValue = -GlassTypeOffset;

			   		if(GestureData.why.trim().substring(0, 1)=="同")
			   		{
			   			GestureData.why = "(同)"+CurrentData[offset+whyIndex+shiftValue];
			   		}

			   		if(GestureData.video.trim().substring(0, 1)=="同")
			   		{
			   			GestureData.video = CurrentData[offset+videoIndex+shiftValue];
			   		}

			   		if(GestureData.method.trim().substring(0, 1)=="同")
			   		{
			   			GestureData.method = "(同)"+CurrentData[offset+methodDescriptionIndex+shiftValue];
			   		}

			   		GestureDataArray.push(GestureData);
		   		}
		   	}
	   };

	   var DivideByName = {};
	   for(var index in GestureDataArray)
	   {
	   		var data = GestureDataArray[index];

	   		if(DivideByName[data.name]==null)
	   		{
	   			DivideByName[data.name] = [];
	   		}

	   		DivideByName[data.name].push(data);
	   }

	   //Get SameOrNot Data
	   var SameOrNot = 
	   {
	   		Same:[],
	   		Different:[],
	   		DifferentWithGroup:{}
	   };



	   for (var i = 0; i < RawData.length; i++) 
	   {
	   		var CurrentData = RawData[i];

   			for(var ConstraintCounter = 0; ConstraintCounter<ConstraintType.length;ConstraintCounter++)
   			{
		   		var offset = ConstraintCounter*ConstraintTypeOffset;
		   		var intent = CurrentData[intentIndex];
		   		var constraint = ConstraintType[ConstraintCounter];
		   		var google = CurrentData[methodDescriptionIndex+offset+GlassTypeOffset*0];
		   		var epson = CurrentData[methodDescriptionIndex+offset+GlassTypeOffset*1];
		   		var DifferentWithGroup = SameOrNot.DifferentWithGroup;
		   		var userName = CurrentData[userNameIndex];

		   		var method = {};
		   		method.rawDataIndex = i;
		   		method.google = google;
		   		method.epson = epson;
		   		method.intent = intent;
		   		method.constraint = constraint;
		   		method.userName = userName;

		   		if(method.google.trim().substring(0, 1)=="同"||method.epson.trim().substring(0, 1)=="同")
		   		{
		   			SameOrNot.Same.push(method);
		   		}
		   		else if(method.google.trim() == method.epson.trim())
		   		{
		   			SameOrNot.Same.push(method);
		   		}
		   		else
		   		{

		   			SameOrNot.Different.push(method);

		   			if(DifferentWithGroup[intent]==null)DifferentWithGroup[intent]=
		   			{
		   					"On-Body":[],
						   	"Phone":[],
						   	"In-Air":[],
		   			};

		   			DifferentWithGroup[intent][constraint].push(method);

		   		}


		   	}
	   };
	 

	   //Get Prefer Sequence
	   var PreferData = 
	   {
	   	"On-Body":[],
	   	"Phone":[],
	   	"In-Air":[],
	   	"All":[],
	   	"Intent":
	   		{	

	   		},
	   };

	   for (var i = 0; i < RawData.length; i++) 
	   {
	   		var CurrentData = RawData[i];

	   		for (var GlassCounter = 0 ; GlassCounter<GlassType.length;GlassCounter++)
   			{
   				var PreferSequence = CurrentData[GlassCounter*GlassTypeOffset+preferSequenceIndex];

   				var ConstraintIndex;

   				if(PreferSequence.substring(0,1)=="I")
   				{//In-Air
   					ConstraintIndex=  2 ;
   				}
   				else if(PreferSequence.substring(0,1)=="手")
   				{//Phone
   					ConstraintIndex = 1;
   				}
   				else if(PreferSequence.substring(0,1)=="O")
   				{//On-Body
   					ConstraintIndex = 0;
   				}

				var GestureData = {};
	   			GestureData.GlassType = GlassType[GlassCounter];
	   			GestureData.ConstraintType = ConstraintType[ConstraintIndex];
		   		GestureData.name = CurrentData[userNameIndex];
		   		GestureData.intent = CurrentData[intentIndex];
		   		GestureData.rating = parseInt(CurrentData[offset+firstRatingIndex]);
		   		GestureData.method = CurrentData[offset+methodDescriptionIndex];
		   		GestureData.rawDataIndex = i;

		   		if(PreferData.Intent[GestureData.intent]==null)
		   		{
		   			PreferData.Intent[GestureData.intent]=
		   			{
		   				"Google":{
			   				"On-Body":[],
		   					"Phone":[],
		   					"In-Air":[],
	   					},
	   					"Epson":{
	   						"On-Body":[],
		   					"Phone":[],
		   					"In-Air":[],
	   					}
		   			};
		   		}

		   		PreferData[GestureData.ConstraintType].push(GestureData);
		   		PreferData["All"].push(GestureData);

		   		PreferData.Intent[GestureData.intent][GestureData.GlassType][GestureData.ConstraintType].push(GestureData);
   			}
	   }


	   //IntentRating
	   var GroupData = {};

	   for (var i = 0; i < GestureDataArray.length; i++) {

	   		var data = GestureDataArray[i];

	   		if(GroupData[data.intent]==null)
	   		{
	   			GroupData[data.intent] = 
	   			{
   					"Google":{
		   				"On-Body":[],
	   					"Phone":[],
	   					"In-Air":[],
   					},
   					"Epson":{
   						"On-Body":[],
	   					"Phone":[],
	   					"In-Air":[],
   					}
	   			}
	   		}

	   		GroupData[data.intent][data.GlassType][data.ConstraintType].push(data);
	   };

	   var IntentRating = {};
	   for(var intentType in GroupData)
	   {
	   		IntentRating[intentType] = {};

	   		for(var glassType in GroupData[intentType])
	   		{
	   			IntentRating[intentType][glassType] = {};

	   			for(var constraintType in GroupData[intentType][glassType])
	   			{
	   				IntentRating[intentType][glassType][constraintType] = 0;

	   				var sum = 0;
	   				for (var i = 0; i < GroupData[intentType][glassType][constraintType].length; i++) {
	   					var data = GroupData[intentType][glassType][constraintType][i];
	   					sum += data.rating;
	   				};

	   				IntentRating[intentType][glassType][constraintType]  = sum / GroupData[intentType][glassType][constraintType].length;
	   			}
	   		}
	   }



  		$.getJSON( "./fileList.json", function( data ) {

  			for(var key in data.mp4)
  			{
  				var entry = data.mp4[key];
  				if(entry.name.indexOf("-")>=0)
  				{
  					var str = entry.name.split(["-"]);

  					var str2 = str[2].split([" "]);

  					var str3 = str2[1].split(["."]);
  					
  					//console.log(str);
  					var date = new Date(str[0], parseInt(str[1])-1, str2[0], str3[0], str3[1], str3[2], 0);
  					entry.date = date;
  				}
  				else if(entry.name.indexOf("VID")>=0)
  				{
  					var fileNameArray = entry.name.split("_");

  					var year = fileNameArray[1].substring(0,4);
  					var month = fileNameArray[1].substring(4,6);
  					var day = fileNameArray[1].substring(6,8);
  					var hour = fileNameArray[2].substring(0,2);
  					var min = fileNameArray[2].substring(2,4);
  					var sec = fileNameArray[2].substring(4,6);

  					var date = new Date(year, month-1, day, hour, min, sec, 0);
  					entry.date = date;

  					//console.log(entry.date);
  				}
  				else
  				{
  					var date = new Date(0, 0, 0, 0, 0, 0, 0);
  					entry.date = date;
  				}
  			}

  			data.mp4.sort(function(a, b){return a.date-b.date});

  			GestureDataArray.sort(function(a, b){
  				var aText = a.intent + a.ConstraintType + a.GlassType;
  				var bText = b.intent + b.ConstraintType + b.GlassType;

  				if ( aText < bText )
				  return -1;
				if ( aText > bText )
				  return 1;
				return 0;
  			});

  			for(var trailId = 0 ; trailId < GestureDataArray.length ; trailId++)
  			{
  				GestureDataArray[trailId].trailId = trailId;
  			}

  			//console.log(data.mp4);

  			for(var key in GestureDataArray)
  			{

  				var entry = GestureDataArray[key];

  				if(entry.video.indexOf("_")<0)
  				{
  					if(entry.video.length == 5)entry.video= "0"+entry.video;
  					else if(entry.video.length!=6)console.log("weird video number:"+entry.video);

	  				var month = parseInt(entry.date.split("/")[0])-1;
	  				var day = entry.date.split("/")[1];
	  				var year = entry.date.split("/")[2].split(" ")[0];
	  				var hour = entry.video.substring(0,2);
	  				var min = entry.video.substring(2,4);
	  				//console.log(min);
	  				var sec = entry.video.substring(4,6);

	  				entry.videoDate = new Date(year,month,day,hour,min,sec,0);

	  				for(var fileIndex = 0;fileIndex<data.mp4.length;fileIndex++)
	  				{
	  					var fileData = data.mp4[fileIndex];

	  					if(fileData.date >= entry.videoDate)
	  					{

	  						entry.file = fileData;
	  						break;
	  					}
	  				}

	  				//console.log("error:file not found " + entry.video + " [raw "+ entry.rawDataIndex +"]");
  				}
  				else
  				{
  					//console.log("?");
  					var error = true;

  					for(var fileIndex = 0;fileIndex<data.mov.length;fileIndex++)
	  				{
	  					var fileData = data.mov[fileIndex];

	  					if(fileData.name.indexOf(entry.video.trim())>=0)
	  					{
	  						entry.file = fileData;
	  						error = false;
	  						break;
	  					}
	  				}

	  					if(error)
	  					{
	  						console.log("error:file not found " + entry.video + " [raw "+ entry.rawDataIndex +"]");
	  					}
  				}
  			}

  			for (var i = 0; i < GestureDataArray.length; i++) {
  				if(GestureDataArray[i].file == null)
  				{
  					console.log("File Not fond");
  					console.log(GestureDataArray[i]);
  				}
  			};

  			d3.csv("./result_huw_final2.csv", function(result_huw) 
  			{
  				//console.log(result_huw);

  				var tagTable = {};
  				

  				var tags = {};

  				for (var i = 0; i < result_huw.length; i++) {
  					var currentTag = result_huw[i];
  					var resultTag = {};

  					var uid = currentTag[1].toString().trim();
  					resultTag.uid = uid;

  					for(var j = 2;j< 15;j++)
  					{
  						var slot = currentTag[j];
  						if(slot == null)continue;
  						slot = slot.trim();

  						var startNum = slot.substring(0,1);
  						if(startNum=="5")
  						{
  							resultTag.position = slot;
  						}

  						if(startNum=="6")
  						{
  							resultTag.position = slot;
  							resultTag.group = slot;
  						}

  						if(startNum!="0"&&startNum!="1"&&startNum!="2"&&startNum!="3"&&startNum!="4"&&startNum!="5"&&startNum!="6"&&startNum!="")
  						{
  							resultTag.group = slot;
  						}
  					}
 
  					tags[uid] = resultTag;
  					//if(uid.indexOf("3D Move")>0)console.log(uid);
  				};

  				//console.log(tags);

  			for (var i = 0; i < GestureDataArray.length; i++) 
  			{
  				var gesture = GestureDataArray[i];

				gesture.uid = gesture.GlassType+"_"+gesture.ConstraintType+"_"+gesture.intent+"_"+gesture.name;

				if(gesture.intent.indexOf("3D Move")>0)
					gesture.uid = gesture.GlassType+"_"+gesture.ConstraintType+"_"+gesture.intent.trim()+" _"+gesture.name;



  				gesture.tag = tags[gesture.uid.toString()];
  			};

  			var spacePosition = 
  			{
  				 "Google":{
		   				"On-Body":{},
	   					"Phone":{},
	   					"In-Air":{},
   					},
   					"Epson":{
   						"On-Body":{},
	   					"Phone":{},
	   					"In-Air":{},
   					}
  			};

  			for (var i = 0; i < GestureDataArray.length; i++) 
  			{
  				var gesture = GestureDataArray[i];

  				if(gesture.tag == null || gesture.tag.position == null || gesture.tag.group == null)
  				{
  					console.log("weird tag:");
  					console.log(gesture);
  					continue;
  				}

  				if(gesture.tag.group.toString().indexOf("Eye")>=0||
  					gesture.tag.group.toString().indexOf("Head")>=0||
  					gesture.tag.group.toString().indexOf("眼")>=0||
  					gesture.tag.group.toString().indexOf("聲")>=0||
  					gesture.tag.group.toString().indexOf("點頭")>=0||
  					gesture.tag.group.toString().indexOf("腦")>=0){
  					//console.log("");
  					//console.log(gesture.tag);
  					continue;
  				}

  				if(spacePosition[gesture.GlassType][gesture.ConstraintType][gesture.tag.position]==null)
  					spacePosition[gesture.GlassType][gesture.ConstraintType][gesture.tag.position]=[];

  				spacePosition[gesture.GlassType][gesture.ConstraintType][gesture.tag.position].push(gesture);
  			}


  			 var groupAgreement = 
  			{
  				 "Google":{
		   				"On-Body":{},
	   					"Phone":{},
	   					"In-Air":{},
   					},
   					"Epson":{
   						"On-Body":{},
	   					"Phone":{},
	   					"In-Air":{},
   					}
  			};

			for (var i = 0; i < GestureDataArray.length; i++) 
  			{
  				var gesture = GestureDataArray[i];

  				if(gesture.tag == null || gesture.tag.position == null || gesture.tag.group == null)
  				{
  					continue;
  				}

  				if(groupAgreement[gesture.GlassType][gesture.ConstraintType][gesture.tag.group]==null)
  					groupAgreement[gesture.GlassType][gesture.ConstraintType][gesture.tag.group]=[];

  				groupAgreement[gesture.GlassType][gesture.ConstraintType][gesture.tag.group].push(gesture);
  			}
  			


  			var Result = {};
  			Result.groupAgreement = groupAgreement;
			Result.SameOrNot = SameOrNot;
			Result.GestureDataArray = GestureDataArray;
			Result.GroupData = GroupData;
			Result.RawData = RawData;
			Result.PreferData = PreferData;
			Result.IntentRating = IntentRating;
			Result.DivideByName = DivideByName;
			Result.spacePosition = spacePosition;
			Result.tags = tags;


			console.log(Result);
			//console.log(data);

			//此部分拿來畫圖
			//printDifferentMethod(SameOrNot.DifferentWithGroup); //不同眼鏡造成操作不同？
			//printIntentAndPreferedRating(IntentRating); // 全部 Rating 分佈
			//printIntentAndPreferedConstraint(PreferData); // 全部 Prefer 分佈

			//以下要跑統計
			//printConstraintTypeAndRating(GestureDataArray); //Constraint 與 User Rating
			//printGlassTypeAndRating(GestureDataArray); //GlassType與UserRating的關係


			//printIntentTypeAndRating(GestureDataArray);

			//$("p").text( JSON.stringify(GestureDataArray) );

  			});
	   });
	});

	var printIntentTypeAndRating = function (GestureDataArray)
	{
		$("p").append("gestureName,rating<br>");

		for (var i = 0; i < GestureDataArray.length; i++) 
		{
			var gesture = GestureDataArray[i];
			var gestureID = gesture.intent.substring(0,2);
			var line = gesture.intent + "," + gesture.rating + "<br>";
			$("p").append(line);

		};
	};

	var printConstraintTypeAndRating = function (GestureDataArray)
	{
		$("p").append("interaction,constraint,rating<br>");

		for (var i = 0; i < GestureDataArray.length; i++) 
		{
			var gesture = GestureDataArray[i];
			var constraint = gesture.ConstraintType;
			var line = gesture.intent+","+constraint + "," + gesture.rating + "<br>";
			$("p").append(line);
		};
	};

	var printGlassTypeAndRating = function (GestureDataArray)
	{
		$("p").append("glassType,constraint,rating<br>");

		for (var i = 0; i < GestureDataArray.length; i++) 
		{
			var gesture = GestureDataArray[i];
			var glassType = gesture.GlassType;
			var constraintType = gesture.ConstraintType;
			var line = glassType +","+constraintType+ "," + gesture.rating + "<br>";
			$("p").append(line);
		};
	};

	var printIntentAndPreferedConstraint = function(PreferData)
	{
		$("p").append("GlassType,Google Glass,,,,Epson BT-200,,<br>");
		$("p").append("Intent,On-Body,In-Air,Phone,,On-Body,In-Air,Phone<br>");

		for(var key in PreferData.Intent)
		{
			var data = PreferData.Intent[key];

			var googleData = data.Google;
			var EpsonData = data.Epson;

			$("p").append(key+","+googleData["On-Body"].length+","+googleData["In-Air"].length+","+googleData["Phone"].length+",,"+EpsonData["On-Body"].length+","+EpsonData["In-Air"].length+","+EpsonData["Phone"].length+",<br>");
		}
	}

	var printIntentAndPreferedRating = function(IntentRating)
	{
		$("p").append("GlassType,Google Glass,,,,Epson BT-200,,<br>");
		$("p").append("Intent,On-Body,In-Air,Phone,,On-Body,In-Air,Phone<br>");
		for(var key in IntentRating)
		{
			var data = IntentRating[key];

			var googleData = data.Google;
			var EpsonData = data.Epson;

			$("p").append(key+","+googleData["On-Body"]+","+googleData["In-Air"]+","+googleData["Phone"]+",,"+EpsonData["On-Body"]+","+EpsonData["In-Air"]+","+EpsonData["Phone"]+",<br>");
		}
	}

	var printDifferentMethod = function(SameOrNotGroup)
	{
		$("p").append("Intent,On-Body,In-Air,Phone,<br>");

		//console.log(SameOrNotGroup.length);
		for(var key in SameOrNotGroup)
		{
			var data = SameOrNotGroup[key];
			$("p").append(key+","+data["On-Body"].length+","+data["In-Air"].length+","+data["Phone"].length+"<br>");	
		}
	}


	</script>
</head>
<body>
	<p>
		
	</p>
</body>
</html>